# Dogfooding Log - 2025-12-22

## Session 1: Agent file resolution issue

**Command:** `moss agent "Review the session_analysis.py file..."`

**Result:** FAILED - max turns reached

**Issues identified:**
1. **Path resolution failing**: Agent tried `session_analysis.py` without `src/moss/` prefix
   - Intent: `skeleton session_analysis.py`
   - Output: `File not found: /home/me/git/moss/session_analysis.py`
   - Expected: Should resolve to `src/moss/session_analysis.py`

2. **Stuck in retry loop**: Same intent repeated 3x across 5 turns
   - No fallback strategy when file not found
   - Should try fuzzy path resolution or ask for clarification

3. **Grep found wrong file**: Found the log file being written instead of source
   - Log file was being written to as the command ran
   - Race condition or should exclude logs directory

**Improvements to consider:**
- [ ] Better path fuzzy resolution in DWIM intent parser
- [ ] Add retry-with-different-approach logic
- [ ] Exclude common non-code directories (logs, .git, etc) from grep by default

---

## Session 2: Vanilla workflow success

**Command:** `moss workflow run vanilla --file src/moss/session_analysis.py --arg "task=..."`

**Result:** SUCCESS - 1 LLM call, 228 tokens, 3.16s

**Notes:**
- Workflow with explicit path works
- Minimal token usage (good efficiency)
- Fast execution

---

## Session 3: Vanilla workflow analysis

**Questions raised:**
1. What did the LLM actually output? → CLI doesn't show this!
2. Does vanilla have editing tools? → Only `patch.apply <description>` (not a real edit)
3. Token-efficient format? → Vanilla prompt uses terse commands (no JSON, no MCP)

**Vanilla prompt format** (`src/moss/prompts/vanilla.txt`):
```
tree.format [path]
skeleton.format <file>
search.grep <pattern> [path]
patch.apply <description>
done [summary]
```

**Issues identified:**
- No verbose output for LLM responses
- No real editing tools in vanilla workflow
- `patch.apply` is just a description, not actual editing
- Workflow result doesn't show step details by default

---

## Session 4: Understanding vanilla vs agent execution

**Key finding:** `moss workflow run vanilla` != `moss agent`

The vanilla workflow only does a single LLM call (step: `agent.step`). It outputs a command like `skeleton.format <file>` but doesn't execute it because:
1. No command parser in the workflow
2. No loop to iterate on results
3. `agent.step` just returns LLM output as-is

**The proper agentic loop is `moss agent`** which uses DWIMLoop:
1. Get terse intent from LLM
2. Parse intent via DWIM
3. Execute tool via MossAPI
4. Store result
5. Repeat until "done" or limit

**Recommendation:**
- Use `moss agent "task"` for agentic execution with tools
- Vanilla workflow is just a single-shot LLM prompt, not a loop
- Could add a new workflow template that wraps DWIMLoop

---

## Session 5: Fixed path resolution and 3 primitives

**Changes made:**
1. Updated DWIMLoop system prompt to use 3 primitives (view, edit, analyze)
2. Added view/analyze handlers in `_run_tool_logic` that route to Rust CLI
3. Rust CLI has built-in fuzzy path resolution: `dwim.py` → `src/moss/dwim.py`

**Test results:**
```
$ moss agent "View the file dwim.py" --max-turns 3 --verbose
--- Turn 1 ---
Intent: view dwim.py
Output: { "path": "src/moss/dwim.py", ... }  # Resolved correctly!

--- Turn 2 ---
Intent: done
Completed in 2 turns
```

**Remaining issues:**
- Agent behavior still inconsistent (some runs hit max turns for same query)
- Need retry-with-different-approach logic when stuck

---

## Session 6: Simplified agent prompt

**Changes made:**
- Removed `-f`/`-s` flags from prompt examples (caused LLM to use `view -s` which doesn't exist)
- Simplified to just `view <path>`, `edit <file> "task"`, `analyze`, `done`
- Added fuzzy path example: `view dwim.py` resolves to `src/moss/dwim.py`

**Test results:**
```
$ moss agent "Show the resolve_core_primitive function in dwim.py"
--- Turn 1 ---
Intent: view dwim.py/resolve_core_primitive
Output: { "file": "src/moss/dwim.py", "source": "def resolve_core_primitive..." }

--- Turn 2 ---
Intent: done resolve_core_primitive function in src/moss/dwim.py located
Completed in 2 turns
```

**Working:**
- Fuzzy path resolution: `dwim.py` → `src/moss/dwim.py`
- Symbol path: `dwim.py/resolve_core_primitive` → shows function source
- Agent completes successfully in 2 turns

**Known limitation:**
- Module-level constants (like CORE_PRIMITIVES) not viewable as symbols
- Rust CLI only indexes classes/functions, not constants

---

## Areas for improvement logged to TODO.md:
- [x] DWIM path resolution - FIXED via Rust CLI passthrough
- [ ] Agent retry strategies
- [x] Verbose mode for workflow runs
- [x] Document that `moss agent` is the proper agentic loop
- [x] Update agent prompt to 3 primitives (view, edit, analyze)
