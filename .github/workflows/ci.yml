name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --extra all --extra dev

      - name: Run ruff check
        run: uv run ruff check src tests

      - name: Run ruff format check
        run: uv run ruff format --check src tests

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.13"]  # Project requires Python 3.13+
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --extra all --extra dev

      - name: Run tests
        run: uv run pytest tests/ -v --tb=short

  test-coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --extra all --extra dev

      - name: Run tests with coverage
        run: uv run pytest tests/ --cov=moss --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --extra all --extra dev

      - name: Run mypy
        run: uv run mypy src/moss --ignore-missing-imports
        continue-on-error: true  # Don't fail CI on type errors initially

  drift-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --extra all --extra dev

      - name: Check generated interface drift
        run: uv run python scripts/check_gen_drift.py

  rust-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "crates -> target"

      - name: Run Rust tests
        run: cargo test --workspace

  benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "crates -> target"

      - name: Build release
        run: cargo build --release -p moss-cli

      - name: Run benchmarks
        run: |
          ./crates/moss-cli/bench.sh --quick 2>&1 | tee benchmark-results.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results.txt

      - name: Check for major regressions
        run: |
          # Parse results and check against thresholds
          # Fast commands should be < 50ms, slow commands < 1000ms
          python3 << 'EOF'
          import re
          import sys

          thresholds = {
              "path": 50,
              "expand": 50,
              "callers": 50,
              "callees": 50,
              "search-tree": 50,
              "tree": 100,
              "symbols": 100,
              "skeleton": 100,
              "complexity": 100,
              "deps": 100,
              "anchors": 100,
              "summarize": 150,
              "health": 1000,
          }

          with open("benchmark-results.txt") as f:
              content = f.read()

          failures = []
          for line in content.split("\n"):
              match = re.match(r"(\S+)\s+(\d+)\s*ms", line.strip())
              if match:
                  name, ms = match.groups()
                  ms = int(ms)
                  # Find matching threshold (prefix match)
                  for key, threshold in thresholds.items():
                      if name.startswith(key):
                          if ms > threshold:
                              failures.append(f"{name}: {ms}ms > {threshold}ms threshold")
                          break

          if failures:
              print("Benchmark regressions detected:")
              for f in failures:
                  print(f"  - {f}")
              sys.exit(1)
          else:
              print("All benchmarks within thresholds")
          EOF
